name: CI for Develop

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'backend/meta-service/**'
      - 'backend/services/auth-service/**'
      - 'backend/services/account-service/**'
      - 'backend/services/interest-service/**'
      - 'backend/services/jobs-service/**'
      - 'backend/services/earnings-service/**'

permissions:
  contents: read
  pull-requests: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1) Check out code (with submodules).
      - name: Check out code
        uses: actions/checkout@v3
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          submodules: recursive

      # 2) Place your SSH key in ~/.ssh so the Makefile can add it via "ls ~/.ssh/id_*"
      - name: Place SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci

      # ---------- install make 4 .4 .1 (≈ 90 s once, then cached) ----------
      - name: Cache GNU make 4.4.1 build
        id: cache-make
        uses: actions/cache@v4
        with:
          path: ~/opt/make-4.4.1           # change if you bump the version
          key: make-4.4.1-${{ runner.os }}

      - name: Build + install GNU make 4.4.1
        if: steps.cache-make.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update -qq
          # flock is provided by util-linux on Ubuntu 24.04
          sudo apt-get install -y --no-install-recommends build-essential wget tar ca-certificates util-linux
          wget -q https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz
          tar -xzf make-4.4.1.tar.gz
          cd make-4.4.1
          ./configure --prefix=$HOME/opt/make-4.4.1 --quiet
          make -j"$(nproc)"
          make install

      - name: Add make 4.4.1 to PATH
        run: echo "$HOME/opt/make-4.4.1/bin" >> "$GITHUB_PATH"

      - name: Show version to prove it worked
        run: make --version   

      - name: Install Docker 28
        uses: docker/setup-docker-action@v4
        with:
          version: v28.0.0

      - name: Upgrade to Docker Compose v2.33.1
        uses: docker/setup-compose-action@v1
        with:
          version: v2.33.1          # same tag that appears on GitHub releases
          cache-binary: true        # speeds up subsequent jobs (default = true)

      - uses: docker/setup-buildx-action@v3
        with:
          install: true              # puts `docker buildx` on PATH
          driver: docker

      # 2) (optional) sanity‑check
      - run: docker compose version   # → Docker Compose version v2.33.1

      # ─── 1) discover which service folders changed ────────────────────────────
      - name: Filter changed paths (dorny)
        id: svc
        uses: dorny/paths-filter@v3
        with:
          list-files: shell          # newline-separated file lists
          filters: |
            meta:     backend/meta-service/**
            auth:     backend/services/auth-service/**
            account:  backend/services/account-service/**
            interest: backend/services/interest-service/**
            jobs:     backend/services/jobs-service/**
            earnings: backend/services/earnings-service/**

      # ─── 2) run `make ci` once per changed folder ────────────────────────────
      - name: Run make ci for each changed service
        if: steps.svc.outputs.changes != '[]'          # skip if nothing matched
        env:
          CHANGES:              ${{ steps.svc.outputs.changes }}   # JSON array
          BWS_CLIENT_ID:        ${{ secrets.BWS_CLIENT_ID }}
          BWS_CLIENT_SECRET:    ${{ secrets.BWS_CLIENT_SECRET }}
          BWS_ACCESS_TOKEN:    ${{ secrets.BWS_ACCESS_TOKEN }}
          UNIQUE_RUNNER_ID:     ${{ secrets.UNIQUE_RUNNER_ID }}
          UNIQUE_RUN_NUMBER:    ${{ github.run_number }}
          LOG_LEVEL:            debug
        run: |
          # ubuntu-latest already has jq; if your runner ever lacks it:
          #   sudo apt-get update -qq && sudo apt-get install -y jq
          for svc in $(echo "$CHANGES" | jq -r '.[]'); do
            case "$svc" in
              meta)     dir="backend/meta-service" ;;
              auth)     dir="backend/services/auth-service" ;;
              account)  dir="backend/services/account-service" ;;
              interest) dir="backend/services/interest-service" ;;
              jobs)     dir="backend/services/jobs-service" ;;
              earnings) dir="backend/services/earnings-service" ;;
            esac

            echo "➤ running make ci for $dir"
            make -C "$dir" ci
          done

