name: iOS Build and Upload to TestFlight

permissions:
  contents: write  # Needed if you want to push Podfile.lock changes

on:
  push:
    branches:
      - main
      - testflight

jobs:
  build-and-deploy:
    runs-on: macos-15

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          submodules: recursive

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Select Xcode Version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      - name: Set up Flutter
        uses: flutter-actions/setup-flutter@v3
        with:
          channel: 'beta'
          cache-sdk: true

      - name: Set up Ruby and Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          
      - name: Setup GNU userâ€‘land
        run: |
          brew install make
          sudo ln -sf "$(brew --prefix make)/bin/gmake" /usr/local/bin/make
          echo "$(brew --prefix)/bin" >> "$GITHUB_PATH"
          make --version

      - name: Install All Dependencies via Makefile
        working-directory: frontend/apps/worker-app
        run: make dependencies-ios

      - name: Deploy to TestFlight via Makefile
        working-directory: frontend/apps/worker-app
        env:
          # Secrets for devops-toolkit (used to fetch APP_SECRETS_JSON)
          HCP_CLIENT_ID: ${{ secrets.HCP_CLIENT_ID_GOD }}
          HCP_CLIENT_SECRET: ${{ secrets.HCP_CLIENT_SECRET_GOD }}
          HCP_TOKEN_ENC_KEY: ${{ secrets.HCP_TOKEN_ENC_KEY }}
          UNIQUE_RUNNER_ID: ${{ github.ref_name == 'main' && secrets.UNIQUE_RUNNER_ID || 'jacob-moore' }}
          UNIQUE_RUN_NUMBER: ${{ github.run_number }}
        run: |
          make deploy-ios ENV=${{ github.ref_name == 'main' && 'prod' || 'staging' }} VERBOSE=1

