---

description: Always-on Agent operating protocol for this repository
globs:
alwaysApply: true

-----------------

# Non‑negotiables (enforced every chat)

* Treat this document as the authoritative operating protocol for the Agent in this repo.
* Show a **diff preview and request confirmation before making any code change** (see §11).
* **Never** run Git operations or touch repo settings (see §10).
* **Migrations:** modify the **latest migration file in place**; **never** create a new one; **never** run migration/DB commands or connect to databases (see §3 ▸ Agent‑Specific Migration Guidelines).
* **Secrets:** do not call `bws` directly; rely on Makefiles/Dockerfiles to fetch secrets via `BWS_ACCESS_TOKEN` (see §3).
* **Logging:** tee outputs to log files named `<model-name>-*.log` as specified (see §9).
* Prefer **integration tests**; keep unit tests out for now (see §4.1, §5.1).
* Respect `ENV`, `AUTO_LAUNCH_BACKEND`, and `PARA_DEPS` semantics (see §3).
* When unsure about environment or safety, ask for clarification **before** executing risky operations.

---

# Full Developer Guide (inlined)

## Developer Guide

Welcome to the monorepo! This guide provides all the necessary information for developers to get started with setting up, running, and testing the services and applications.

---

## 1. Prerequisites

Before you begin, ensure you have the following tools installed on your system:

* **Git:** For version control.
* **Docker & Docker Compose:** For running backend services in a containerized environment.
* **GNU Make:** Version 4.4 or higher is recommended. The build system relies heavily on Makefiles.
* **Go:** Version 1.24 or higher for backend development.
* **Flutter:** The stable channel is recommended for mobile app development.
* **Node.js:** For frontend web development.
* **Bitwarden Secrets Manager CLI (`bws`):** For accessing secrets.

You will also need a Bitwarden access token (`BWS_ACCESS_TOKEN`) exported as an environment variable to fetch necessary secrets for local development.

---

## 2. Project Architecture

This monorepo contains backend microservices written in Go and frontend applications built with Flutter and standard web technologies.

* **Backend:** A collection of Go microservices located in `backend/services/`. These services are containerized with Docker and managed via Makefiles. The `backend/meta-service` acts as a gateway, orchestrating and exposing all other backend services for local development.
* **Frontend:** Applications are located in `frontend/apps/`. This includes the Flutter-based `worker-app` for iOS and Android, and `the-website` for the public-facing web presence.
* **Shared Libraries:** Common code is shared across projects. Go packages are in `backend/shared/`, and Flutter packages are in `frontend/shared/`.

---

## 3. Core Concepts

### Secrets Management (Bitwarden)

All secrets (API keys, database URLs, etc.) are managed in Bitwarden Secrets Manager. The `bws` CLI tool, combined with a `BWS_ACCESS_TOKEN`, is used to fetch these secrets at build time.

* **Authentication:** You must have the `BWS_ACCESS_TOKEN` environment variable set in your shell.
* **Usage:** The Makefiles and Dockerfiles are configured to automatically fetch the required secrets for the environment (`dev`, `staging`, etc.) you are working in. You do not need to manually run `bws` commands.

### Database Migrations (Tern)

Database schema changes are managed through SQL migration files located in `backend/migrations`. We use `tern` to apply these migrations.

* **Running Migrations:** Migrations are run automatically as part of the `make up` or `make ci` process. To run them manually:

```bash
# From a service directory, e.g., backend/services/account-service
make migrate
```

* **Creating a New Migration:** Use the `tern new` command. Ensure you are in a directory with a configured `tern.conf` file or provide the path to your migrations.

* **Agent-Specific Migration Guidelines:** When working as an AI agent, you must follow these strict guidelines:

  1. **Always modify the latest migration file** instead of creating new ones.
  2. **Find the latest migration**: Look for the most recent timestamp in the `backend/migrations/` directory.
  3. **Modify in place**: Add your schema changes to the existing latest migration file.
  4. **Rationale**: The latest migration represents the current development state and will be deployed to production.
  5. **Forbidden Actions**:

     * Never create new migration files unless explicitly instructed.
     * Never run migration commands or database setup commands.
     * Never attempt to connect to databases - your changes will be validated by CI.

### Key Environment Variables

You can override the behavior of the build system by setting these variables when running `make` commands.

* **`ENV`**: Specifies the target environment. This is the most important variable as it controls which configuration, secrets, and deployment targets are used.

* `dev-test` (Default): For local development and testing. Connects to local Docker services.

* `dev`: Similar to `dev-test`.

* `staging`: For deployments to the staging environment on Fly.io.

* `prod`: For deployments to the production environment on Fly.io.

* **Usage:** `make up ENV=staging`

* **`AUTO_LAUNCH_BACKEND`**: (Frontend) Automatically starts the backend (`meta-service`) when running frontend tasks like `run-ios` or `ci-android`.

* `1` (Default): The backend is started automatically. Ideal for frontend-focused work.

* `0`: The backend is not started automatically. Useful if you are managing the backend stack manually in a separate terminal.

* **Usage:** `AUTO_LAUNCH_BACKEND=0 make run-android`

* **`PARA_DEPS`**: (Backend) Controls whether dependency tasks are executed in parallel or sequentially.

* `1` (Default): Runs dependency tasks in parallel for faster execution.

* `0`: Runs dependency tasks sequentially. The output is cleaner and easier to debug if there are issues with a specific dependency.

* **Usage:** `PARA_DEPS=0 make up` (from `backend/meta-service`)

---

## 4. Backend Development

All backend services are designed to be run within Docker containers. The `meta-service` is the primary entry point for running the entire backend stack locally.

### Running the Full Backend Stack

For most development, you will want to run all backend services simultaneously.

1. **Navigate to the meta-service directory:**

```bash
cd backend/meta-service
```

2. **Start all services:**

```bash
make up
```

This command will:

* Create a shared Docker network.
* Build Docker images for all dependent services (`auth-service`, `account-service`, etc.).
* Start all services in detached mode.
* Set up a local gateway with `ngrok` to expose the services to your frontend applications. The public URL will be printed in the console.

### Running Individual Services

While developing a specific service, you can run its build and test commands individually from its directory.

* **Build:** `make build` - This command compiles the service to ensure it builds successfully but does not run it.
* **Test:** `make ci` - This command runs the continuous integration pipeline for the service, which typically includes building the code, running database migrations, and executing integration tests within a clean Docker environment.

Below are the paths for each service:

| Service              | Path                                | Test Command | Build Command |
| -------------------- | ----------------------------------- | ------------ | ------------- |
| **account-service**  | `backend/services/account-service`  | `make ci`    | `make build`  |
| **auth-service**     | `backend/services/auth-service`     | `make ci`    | `make build`  |
| **earnings-service** | `backend/services/earnings-service` | `make ci`    | `make build`  |
| **interest-service** | `backend/services/interest-service` | `make ci`    | `make build`  |
| **jobs-service**     | `backend/services/jobs-service`     | `make ci`    | `make build`  |
| **meta-service**     | `backend/meta-service`              | `make ci`    | `make build`  |

## 4.1. Testing Requirements

For every new feature or bug fix in the backend services, you must add or update the corresponding unit and integration tests to ensure code quality and maintain system reliability.

**Note**: We are only writing integration tests for now, but will be adding unit tests in the future.

### Unit Tests

Unit tests should be created for individual functions and methods, focusing on testing business logic in isolation.

* **Location:** Place unit tests alongside the code being tested, following Go conventions (e.g., `service_test.go` for `service.go`)
* **Running Unit Tests:** From any service directory, run:

```bash
go test ./...
```

* **Coverage:** Aim for comprehensive coverage of new functionality and edge cases

**Note:** Do not write unit tests right now. We will be adding unit tests in the future.

### Integration Tests

Integration tests verify that different components work together correctly and are located in each service's `internal/integration/` directory.

* **Location:** `backend/services/<service-name>/internal/integration/`
* **Running Integration Tests:** Use the CI command which includes integration tests:

```bash
make ci
```

* **Requirements:** Integration tests must be updated when:
* Adding new API endpoints
* Modifying existing endpoint behavior
* Changing database schemas or queries
* Updating service interactions

### Static Analysis (Go)

For a faster feedback loop without running the full test suite, you can use static analysis to validate Go code. This is a great way to quickly check for compilation errors and other issues.

1. **Navigate to the service directory**:

   ```bash
   cd backend/services/<service-name>
   ```
2. **Run the analyzer**:

   ```bash
   cd ... && staticcheck -tests -tags="integration,dev_test,dev" ./...
   ```

   If `staticcheck` is not installed, you can use `go vet` as a fallback:

   ```bash
   cd ... && go vet -tags="integration,dev_test,dev" ./...
   ```

---

## 5. Frontend Development

Frontend applications connect to the backend stack running via the `meta-service`.

### Worker App (Flutter)

The `worker-app` is a cross-platform mobile application for gig workers.

* **Path:** `frontend/apps/worker-app`

#### Setup

1. **Install Dependencies:** Before running the app, install the necessary Flutter and native dependencies:

* For iOS: `make dependencies-ios`
* For Android: `make dependencies-android`

#### Running the App

The `run` commands will automatically start the backend stack if it's not already running (`AUTO_LAUNCH_BACKEND=1` is the default).

* **Run on Android:** `make run-android`
* **Run on iOS:** `make run-ios`

#### Building and Running Tests

* **Build (Android):** `make build-android`
* **Test (Android):** `make ci-android`
* **Build (iOS):** `make build-ios`
* **Test (iOS):** `make ci-ios`

### The Website (Web)

This is the main public-facing website.

* **Path:** `frontend/apps/the-website`
* **Build:** `make build-web`
* **Test:** `make ci-web`

### 5.1. Testing Requirements

For every new feature or bug fix in the frontend applications, you must add or update the corresponding API integration tests to ensure code quality and maintain system reliability. This is critical for maintaining a stable data layer and preventing regressions.

#### API Integration Tests

API integration tests verify that the frontend's data layer correctly interacts with the backend services.

* **Location:** `frontend/apps/worker-app/integration_test/api`
* **Running Integration Tests:**

```bash
# For Android
make ci-android

# For iOS
make ci-ios
```

* **Requirements:** API integration tests must be created or updated whenever changes are made to the data layer of the application, including:
* Adding new API service methods
* Modifying existing API service method behavior
* Changing the structure of data models that are sent to or received from the backend

### Static Analysis (Flutter/Dart)

For a faster feedback loop on Dart code, you can use the Flutter analyzer. This is a great way to quickly check for compilation errors, warnings, and style issues without running the full application. Resolve all warnings or deprecation info level issues, and of course errors.

1. **Navigate to the app directory**:

   ```bash
   cd frontend/apps/worker-app
   ```
2. **Run the analyzer**:

   ```bash
   # If you modify .arb files for localization, run this first:
   cd ... && flutter gen-l10n --verbose

   # Then run the analyzer in a way that gaurantees you can capture the output even in escalated priveleges (outside sandbox) mode:
   cd <path/to/flutter/project> && (flutter analyze 2>&1) | sed -n '1,400p'
   ```

### Agent Requirements for Flutter Commands

**Important for Codex AI Agent:** Flutter commands (including `flutter analyze`, `flutter gen-l10n`, and any `make` commands that invoke Flutter) require privilege escalation. If not codex agent, than this is not required or operating inside of a sandbox, this is not required.

---

## 6. Full-Stack Workflow

1. **Start the Backend:** In a terminal, navigate to `backend/meta-service` and run `make up`. Note the ngrok URL that is output.
2. **Configure Frontend:** The frontend applications are configured to use the backend gateway URL provided during the build process. For local development, this is handled automatically by the Makefiles.
3. **Run the Frontend:** In a separate terminal, navigate to the desired frontend app directory (e.g., `frontend/apps/worker-app`) and run the corresponding `make run-[platform]` command. The app will connect to the local backend stack.
4. **Develop:** Make changes to your frontend or backend code. The Go services and Flutter app support hot-reloading for a fast development cycle.
5. **Testing:** Run the appropriate `make ci` command for the backend service or `make ci-[platform]` for the frontend app to execute tests and ensure everything is functioning correctly.

---

## 7. Deployment

Deployments are handled via GitHub Actions and target [Fly.io](https://fly.io).

* **Staging:** The `staging` environment is deployed automatically from the `develop` branch for backend services and the `testflight`/`playstore` branches for mobile apps.
* **Production:** The `prod` environment is deployed automatically from the `main` branch.

The Makefiles in each service contain `deploy-[platform]` targets that are used by the CI/CD pipelines. Manual deployments are generally not required.

---

## 8. CI/CD

The repository is configured with GitHub Actions for continuous integration and deployment. Workflows are located in the `.github/workflows` directory. Pushes to `develop`, `main`, `testflight`, and `playstore` branches will trigger the respective build, test, and deployment pipelines.

---

## 9. Agent Command Logging

When running commands from this guide, all output must be logged to command-specific files for debugging and audit purposes.

### Logging Requirements

* **Log File Format:** All command output must be teed to log files with the prefix `<model name>-` followed by a descriptive name based on the command being executed.
* **Location:** Log files should be created in the current working directory where the command is executed.
* **Command Examples:**

```bash
# Backend service testing
make ci 2>&1 | tee <model name>-service-ci.log

# Flutter builds
make build-android 2>&1 | tee <model name>-flutter-build-android.log
make run-ios 2>&1 | tee <model name>-flutter-run-ios.log

# Static analysis
flutter analyze 2>&1 | tee <model name>-flutter-analyze.log
staticcheck ./... 2>&1 | tee <model name>-go-staticcheck.log

# Database migrations
make migrate 2>&1 | tee <model name>-db-migrate.log

# Backend stack startup
make up 2>&1 | tee <model name>-backend-up.log
```

### Log File Naming Convention

Use descriptive names that identify the operation:

* `<model-name>-<service>-<operation>.log` for service-specific commands
* `<model-name>-<platform>-<action>.log` for platform-specific commands
* `<model-name>-<tool>-<command>.log` for tool-specific operations

This ensures all command execution is tracked and can be reviewed for troubleshooting.

## 10. Code Changes and Version Control Policy

**Important for AI Agents:** When making code changes, you must **NEVER** attempt to commit, push, or otherwise persist changes to version control. All changes should remain as local modifications only.

* **Forbidden Actions:**

  * Never run `git add`, `git commit`, `git push`, or any other git commands
  * Never attempt to create pull requests or merge requests
  * Never modify `.git` configuration or repository settings
  * Never tag releases or create branches

## 11. Development Workflow

**IMPORTANT:** As an AI agent, show diff preview and ask for confirmation before making any changes to the codebase, giving the user a change to review and approve the changes.
